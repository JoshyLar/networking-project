import socket
from threading import Thread
from datetime import datetime
import  shutil
import os

def serve_msg():
    msg = datetime.now().strftime("[%H:%M:%S] ") + "Server:"
    return msg

def listen(client):
    try:
        while True:
            msg = client.recv(1024).decode()
            print(f"incoming message: {msg}")
            if msg == "QUIT_REQUEST_FLAG":

                for user in users:
                    exit_msg = f"{serve_msg()} user {user_names[users.index(client)]} has left the chat"
                    if user != client:
                        user.send(exit_msg.encode())

                client.close()
                print(f"user {user_names[users.index(client)]} quit")
                users.remove(client)
                print(f"Number of  users: {len(users)}")
                break
            elif msg == "ATTACHMENT_FLAG":
                file_name = client.recv(1024).decode()
                client.send(f"ATTACHMENT_FLAG = 0".encode())
                client.send(file_name.encode())
                data = client.recv(1024).decode()
                file = open(file_name, 'w')
                file.write(data)
                file.close()
                shutil.move(file_name,"downloads")
                client.send(f"{serve_msg()}File recieved".encode())
                curr_time = datetime.now().strftime("[%H:%M:%S] ")
                send_msgs(f"{serve_msg()} {user_names[users.index(client)]} has sent an attachment")
                print(data)
                send_msgs(data)
            else:
                msg = user_names[users.index(client)] + ": " + msg
                curr_time = datetime.now().strftime("[%H:%M:%S] ")
                msg = curr_time + msg + "\n"
                for user in users:
                    if user != client:
                        user.send(msg.encode())
    except:
        msg = f"{serve_msg()} user {user_names[users.index(client)]} has left the chat"
        for user in users:
            if user != client:
                user.send(msg.encode())

        client.close()
        print(f"user {user_names[users.index(client)]} quit")
        users.remove(client)
        print(f"Number of  users: {len(users)}")






def send_msgs(msg):
    messages.append(msg)
    for user in users:
        if msg != "ATTACHMENT_FLAG= 1":
            user.send(msg.encode())

def check_user_names(user_name):
    if len(user_names) != 0:
        for users in user_names:
            print(users)
            if user_name == users:
                return 0
    return 1


if __name__ == '__main__':
    users = []
    user_names = []
    user_addr = []
    messages = []
    chat_room_size = 3

    server_port = 18005
    host_name = 'local host'

    serverSocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    name = socket.gethostname()
    server_ip = socket.gethostbyname(name)  # get the server ip
    serverSocket.bind(('', server_port))
    serverSocket.listen()

    print("server IP= ", server_ip, "port= ", server_port)
    print('The server is ready to receive')


    while True:

        connectionSocket, addr = serverSocket.accept()
        print("join requested")
        connectionSocket.send('server connection acknowledged\n'.encode())

        msg = connectionSocket.recv(1024).decode()


        user_name_flag = 0

        if msg == "JOIN_REQUEST_FLAG":
            print("username requested")
            if (len(users) > chat_room_size + 1):
                print("Chatroom full user rejected")
                connectionSocket.send('JOIN_REJECT_FLAG'.encode())
                connectionSocket.close()
            connectionSocket.send("JOIN_REQUEST_FLAG = 1".encode())


            while user_name_flag == 0:





                user_name = connectionSocket.recv(1024).decode()
                user_name_flag = check_user_names(user_name)
                if user_name_flag == 0:
                    connectionSocket.send('JOIN_REJECT_FLAG'.encode())

                else:
                    connectionSocket.send('JOIN_ACCEPT_FLAG = 1'.encode())
                    if len(messages) != 0:
                        history = ""
                        for i in messages:
                            history += history + i
                        connectionSocket.send(history.encode())
                    msg = f"{serve_msg()} {user_name} has joined the chat\n"
                    send_msgs(msg)
                    users.append(connectionSocket)
                    user_names.append(user_name)
                    user_addr.append(addr)

                    connectionSocket.send(f"{serve_msg()} Welcome to the chat {user_name}\n".encode())
                    thread = Thread(target=listen, args=(connectionSocket,))

                    thread.daemon = True

                    thread.start()
                    print(f"New user added. Number of  users: {len(users)}")
                    user_name_flag == 1




        elif msg == "REPORT_REQUEST_FLAG":
            print("report requested")
            if len(users) > 0:

                string = ""
                for i in range(len(user_names)):
                    string += user_names[i] + " ip: " + str(user_addr[i][0]) + " port: " + str(user_addr[i][0] + "\n")
                    print(string)
                connectionSocket.send(string.encode())
            else:
                connectionSocket.send('chat room empty'.encode())
        elif msg == "QUIT_REQUEST_FLAG":
            connectionSocket.send("QUIT_ACCEPT_FLAG".encode())
            connectionSocket.close()
            print(f"user {connectionSocket} connection terminated")
            break











    msg = ""


    for connectionSocket in users:
        connectionSocket.close()

    serverSocket.close()

